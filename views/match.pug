extends layout.pug

block scripts
	link(rel='stylesheet', href='/css/site.css')
	script.
		$(function () {
			jQuery.getScript("/js/fastclick.js", function() {
			    new FastClick(document.documentElement);
			    // FastClick.attach(document.body);
			});

			var scores = { };

			$( document ).ready(function() {
				window.darts_thrown = 0;
				$(document).scrollTop(170);
			});

			$('#score_selector_table .throw_buttons :button').click(function () {
				var dart;
				if (window.darts_thrown === 0) {
					dart = $('#first');
				}
				else if (window.darts_thrown === 1) {
					dart = $('#second');
				}
				else if (window.darts_thrown === 2) {
					dart = $('#third');
				}
				else {
					alert('Please submit previous score!');
					return;
				}
				var multiplier = $(this).data('multiplier');
				/*var multiplierText = '';
				if (multiplier == 2) {
					multiplierText = 'D-' + $(this).text().substring(0, $(this).text().length - 2);
				}
				else if (multiplier == 3) {
					multiplierText = 'T-' + $(this).text().substring(0, $(this).text().length - 3);
				}
				else {
					multiplierText = $(this).text().substring(0, $(this).text().length - 1);
				}
				dart.text(multiplierText);*/

				dart.text($(this).attr('title'));
				dart.attr('data-multiplier', multiplier);

				var currentPlayer = $('#current_player');
				var currentPlayerScore = parseInt(currentPlayer.text());
				var scoreNumeric = parseInt($(this).attr('title'));
				var dartScore = scoreNumeric ? scoreNumeric : 0;

				var scoreAfterThrow = parseInt(currentPlayerScore - scoreNumeric);

				var isBust = false;

				// Is the game over
				if (scoreAfterThrow == 0) {
					if (multiplier == 2) {
						console.log('Game finished');

						var firstScoreNumeric = parseInt($('#first').text() / $('#first').attr('data-multiplier'));
						var secondScoreNumeric = parseInt($('#second').text() / $('#second').attr('data-multiplier'));
						var thirdScoreNumeric = parseInt($('#third').text() / $('#third').attr('data-multiplier'));
						var firstScoreMultiplier = parseInt($('#first').attr('data-multiplier'));
						var secondScoreMultiplier = parseInt($('#second').attr('data-multiplier'));
						var thirdScoreMultiplier = parseInt($('#third').attr('data-multiplier'));

						var submitButton = $('#submitScoreButton');

						var matchId = submitButton.data('match-id');
						var currentPlayerId = submitButton.data('current-player-id');

						var data = JSON.stringify({
							'matchId': matchId,
							'playerId': currentPlayerId,
							'firstDart': firstScoreNumeric,
							'secondDart': secondScoreNumeric,
							'thirdDart': thirdScoreNumeric,
							'firstDartMultiplier': firstScoreMultiplier,
							'secondDartMultiplier': secondScoreMultiplier,
							'thirdDartMultiplier': thirdScoreMultiplier,
						});
						executePost(window.location.pathname + '/finish', data, 'application/json',
							function (response) {
								window.darts_thrown = 0; // Reset darts thrown
								location.href = window.location.pathname + '/results';
							},
							function (error) {
								// TODO Error handling
								console.log("Unable to add score: " + error.responseText);
							}
						);
						return;
					} else {
						isBust = true;
					}
				} else if (scoreAfterThrow == 1 || scoreAfterThrow < 0) {
					isBust = true;
				}

				if (isBust) {
					if (confirm('Bust')) {
						// Bust, 'click' submit
						var submitButton = $('#submitScoreButton');
						submitButton.data('busted', 1).trigger('click');
						return;
					} else {
						// Just in case someone made a mistake, go back to last dart
						window.darts_thrown--;
						// Revert the score
						currentPlayer.text(parseInt(currentPlayer.text()) + scoreNumeric);
						// Clear the score for thrown dart
						dart.text('');
					}
				} else {
					currentPlayer.text(scoreAfterThrow);
					scores[window.darts_thrown] = dartScore;
					window.darts_thrown++;
				}
			});

			$('#submitScoreButton').click(function() {
				var firstScoreNumeric = parseInt($('#first').text() / $('#first').attr('data-multiplier'));
				var secondScoreNumeric = parseInt($('#second').text() / $('#second').attr('data-multiplier'));
				var thirdScoreNumeric = parseInt($('#third').text() / $('#third').attr('data-multiplier'));
				var firstScoreMultiplier = parseInt($('#first').attr('data-multiplier'));
				var secondScoreMultiplier = parseInt($('#second').attr('data-multiplier'));
				var thirdScoreMultiplier = parseInt($('#third').attr('data-multiplier'));

				var matchId = $(this).data('match-id');
				var currentPlayerId = $(this).data('current-player-id');
				var playersInMatch = $(this).data('players-in-match');
				var isBust = $(this).data('busted');

				var data = JSON.stringify({
					'matchId' : matchId,
					'playerId' : currentPlayerId,
					'firstDart' : firstScoreNumeric,
					'secondDart' : secondScoreNumeric,
					'thirdDart' : thirdScoreNumeric,
					'firstDartMultiplier': firstScoreMultiplier,
					'secondDartMultiplier': secondScoreMultiplier,
					'thirdDartMultiplier': thirdScoreMultiplier,
					'playersInMatch': playersInMatch,
					'isBust': isBust,
				});
				executePost(window.location.pathname + '/throw', data, 'application/json',
					function(response) {
						window.darts_thrown = 0; // Reset darts thrown
						location.href = window.location.pathname;
					},
					function(error){
						// TODO Error handling
						console.log("Unable to add score: " + error.responseText);
					}
				);
			});

			$('#undoButton').click(function() {
				if (window.darts_thrown < 1) {
					return;
				}

				var currentPlayer = $('#current_player');
				var currentPlayerScore = parseInt(currentPlayer.text());
				window.darts_thrown--;
				currentPlayer.text(currentPlayerScore + scores[window.darts_thrown]);

				var dart;
				if (window.darts_thrown === 0) {
					dart = $('#first');
				}
				else if (window.darts_thrown === 1) {
					dart = $('#second');
				}
				else if (window.darts_thrown === 2) {
					dart = $('#third');
				}
				dart.text('');
			});

			$('#seeScoresButton').click(function() {
				$('#scoresModal').modal('show');
			});
			$('#cancelMatchButton').click(function() {
				// TODO Confirm dialog?
				executeDelete(window.location.pathname + '/cancel',
					function(response) {
						location.href = '/match/list';
					},
					function(error) {
						var alert = $('#cancelMatchFailedAlert');
						alert.show();
						alert.text('Unable to cancel match, see log for details (' + error.statusText + ')');
					}
				);
			});
		});

block content
	div(id='cancelMatchFailedAlert' class='alert alert-danger' role='alert' hidden='true').
		Unable to cancel match

	h2= 'Match'
	div(class='table-responsive')
		table(id='score_selector_table' class='table')
			thead
				tr(class='row no-border')
					th(colspan='3')
					th(colspan='2') First
					th(colspan='2') Second
					th(colspan='2') Third
					th(colspan='2') Submit
					th(colspan='2')
			tbody
				tr(class='row')
					td(colspan='3' class='no-border')
					td(colspan='2' class='dart-score-container no-border'): label(id='first' text='0' data-multiplier='1')
					td(colspan='2' class='dart-score-container no-border'): label(id='second' text='0' data-multiplier='1')
					td(colspan='2' class='dart-score-container no-border'): label(id='third' text='0' data-multiplier='1')
					td(colspan='2'): button(id='submitScoreButton' type='button' style='line-height:1.5' class='btn-score btn-info btn-lg btn-block' data-match-id=match.id data-current-player-id=match.current_player_id data-players-in-match=match.player2match data-busted='0') Submit
					td(colspan='2')
						button(id='undoButton' type='button' class='btn-score btn-info btn-lg btn-block')
							span(class='glyphicon glyphicon-arrow-left' style='line-height:1.5' aria-hidden='true')
				- var length = 12 / Object.keys(players).length
				tr(class='row')
					td
					each player in players
						if player.id=player.current
							td(colspan=length class='label-active-player')
								label(class='label label-block label-player-score' id=player.current ? 'current_player' : 'label_' + player.id)= player.current_score
								label(class='label-player-name' id='label_player_name_' + player.name)= player.name
						else
							td(colspan=length class='label-inactive-player')
								label(class='label label-block label-player-score' id=player.current ? 'current_player' : 'label_' + player.id)= player.current_score
								label(class='label-player-name' id='label_player_name_' + player.name)= player.name
				tr(class='throw_buttons row')
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='0' data-multiplier='1') Miss<br/>&nbsp;
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='20' data-multiplier='1') 20<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='19' data-multiplier='1') 19<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='18' data-multiplier='1') 18<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='17' data-multiplier='1') 17<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block btn-double' title='40' data-multiplier='2') 20<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block btn-double' title='38' data-multiplier='2') 19<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block btn-double' title='36' data-multiplier='2') 18<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block btn-double' title='34' data-multiplier='2') 17<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block btn-triple' title='60' data-multiplier='3') 20<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block btn-triple' title='57' data-multiplier='3') 19<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block btn-triple' title='54' data-multiplier='3') 18<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block btn-triple' title='51' data-multiplier='3') 17<br/>...
				tr(class='throw_buttons row')
					td(rowspan='2' style='height:100%; background-color: #ffe6cc;')
						button(type='button' style='height:100%;overflow: auto;' class='btn-score btn-info btn-lg btn-block btn-double' title='25' data-multiplier='1') Bull<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='16' data-multiplier='1') 16<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='15' data-multiplier='1') 15<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='14' data-multiplier='1') 14<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='13' data-multiplier='1') 13<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='32' data-multiplier='2') 16<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='30' data-multiplier='2') 15<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='28' data-multiplier='2') 14<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='26' data-multiplier='2') 13<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='48' data-multiplier='3') 16<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='45' data-multiplier='3') 15<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='42' data-multiplier='3') 14<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='39' data-multiplier='3') 13<br/>...
				tr(class='throw_buttons row')
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='12' data-multiplier='1') 12<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='11' data-multiplier='1') 11<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='10' data-multiplier='1') 10<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='9' data-multiplier='1') 9<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='24' data-multiplier='2') 12<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='22' data-multiplier='2') 11<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='20' data-multiplier='2') 10<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='18' data-multiplier='2') 9<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='36' data-multiplier='3') 12<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='33' data-multiplier='3') 11<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='30' data-multiplier='3') 10<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='27' data-multiplier='3') 9<br/>...
				tr(class='throw_buttons row')
					td(rowspan='2' style='height:100%; background-color: #ffcc66;')
						button(type='button' style='height:100%;' class='btn-score btn-info btn-lg btn-block btn-triple' title='50' data-multiplier='2') Bull<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='8' data-multiplier='1') 8<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='7' data-multiplier='1') 7<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='6' data-multiplier='1') 6<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='5' data-multiplier='1') 5<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='16' data-multiplier='2') 8<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='14' data-multiplier='2') 7<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='12' data-multiplier='2') 6<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='10' data-multiplier='2') 5<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='24' data-multiplier='3') 8<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='21' data-multiplier='3') 7<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='18' data-multiplier='3') 6<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='15' data-multiplier='3') 5<br/>...
				tr(class='throw_buttons row')
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='4' data-multiplier='1') 4<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='3' data-multiplier='1') 3<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='2' data-multiplier='1') 2<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block' title='1' data-multiplier='1') 1<br/>.
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='8' data-multiplier='2') 4<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='6' data-multiplier='2') 3<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='4' data-multiplier='2') 2<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-double' title='2' data-multiplier='2') 1<br/>..
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='12' data-multiplier='3') 4<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='9' data-multiplier='3') 3<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='6' data-multiplier='3') 2<br/>...
					td: button(type='button' class='btn-score btn-info btn-lg btn-block  btn-triple' title='3' data-multiplier='3') 1<br/>...

	div(class='btn-group')
		button(type='button' class='btn btn-primary btn-block dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false') Advanced
			span(class='caret')
		ul(class='dropdown-menu')
			li: a(id='seeScoresButton') See scores
			li: a(id='cancelMatchButton') Cancel Match


	div(class='modal fade' id='scoresModal' tabindex='-1' role='dialog' aria-labelledby='scoresModalLabel')
		div(class='modal-dialog' role='document')
			div(class='modal-content')
				div(class='modal-header')
					button(type='button' class='close' data-dismiss='modal' aria-label='Close')
						span(aria-hidden='true') &times;
					h4(class='modal-title' id='scoresModalLabel') Scores
				div(class='modal-body')
					form
						div(class='table-responsive')
							table(class='table')
								thead
									tr(class='row')
										th #
										th Player
										th When
										th First
										th Second
										th Third
								tbody
									each score in match.scores
										tr(class='row')
											td= score.id
											td= players[score.player_id].name
											td= score.created_at
											td= score.first_dart * score.first_dart_multiplier
											td= score.second_dart * score.second_dart_multiplier
											td= score.third_dart * score.third_dart_multiplier
					div(class='modal-footer')
						button(type='button' class='btn btn-default' data-dismiss='modal') Close
