extends layout.pug

block scripts
	script.
		$(document).ready(function(){
			$('#hits_table').DataTable({
				searching: false,
		    	bInfo : false,
		    	order: [[ 2,  'desc' ]],
		        columnDefs: [ { targets: [ 1 ], visible: true } ]
			});
		});
	script.
		$(function () {
			$('.edit-visit').click(function () {
				var visitNumber = $(this).data('visit');

				var firstDartField = $('#first-dart-visit-' + visitNumber);
				var secondDartField = $('#second-dart-visit-' + visitNumber);
				var thirdDartField = $('#third-dart-visit-' + visitNumber);

				var firstDartMultiplierField = $('#first-dart-multiplier-visit-' + visitNumber);
				var secondDartMultiplierField = $('#second-dart-multiplier-visit-' + visitNumber);
				var thirdDartMultiplierField = $('#third-dart-multiplier-visit-' + visitNumber);

				var firstDartValue = firstDartField.data('score');
				var secondDartValue = secondDartField.data('score');
				var thirdDartValue = thirdDartField.data('score');

				var firstDartMultiplierValue = firstDartMultiplierField.data('multiplier');
				var secondDartMultiplierValue = secondDartMultiplierField.data('multiplier');
				var thirdDartMultiplierValue = thirdDartMultiplierField.data('multiplier');

				if ($(this).data('issave') == 1) {
					var firstScoreChanged = firstDartField.children('input').val();
					var secondScoreChanged = secondDartField.children('input').val();
					var thirdScoreChanged = thirdDartField.children('input').val();

					// Handle miss (set multiplier to 1 automatically)
					if (firstScoreChanged == 0) {
						firstDartMultiplierField.children('input').val('1');
					}
					if (secondScoreChanged == 0) {
						secondDartMultiplierField.children('input').val('1');
					}
					if (thirdScoreChanged == 0) {
						thirdDartMultiplierField.children('input').val('1');
					}

					var firstMultiplierChanged = firstDartMultiplierField.children('input').val();
					var secondMultiplierChanged = secondDartMultiplierField.children('input').val();
					var thirdMultiplierChanged = thirdDartMultiplierField.children('input').val();

					if (isNaN(firstScoreChanged) || isNaN(firstMultiplierChanged) ||
						isNaN(secondScoreChanged) || isNaN(secondMultiplierChanged) ||
						isNaN(thirdScoreChanged) || isNaN(thirdMultiplierChanged)) {
						alert('Please enter numeric value.');
						return;
					}

					if (firstScoreChanged < 0 || firstScoreChanged > 20 || firstMultiplierChanged < 1 || firstMultiplierChanged > 3) {
						alert('Incorrect values for first dart.');
						return;
					}

					if (secondScoreChanged < 0 || secondScoreChanged > 20 || secondMultiplierChanged < 1 || secondMultiplierChanged > 3) {
						alert('Incorrect values for second dart.');
						return;
					}

					if (thirdScoreChanged < 0 || thirdScoreChanged > 20 || thirdMultiplierChanged < 1 || thirdMultiplierChanged > 3) {
						alert('Incorrect values for third dart.');
						return;
					}

					// We have correct values, let's change the summary and ppd displayed
					var total = firstScoreChanged * firstMultiplierChanged +
							secondScoreChanged * secondMultiplierChanged +
							thirdScoreChanged * thirdMultiplierChanged;
					$('.total-visit-score-' + visitNumber).text(total);

					var ppd = (total / 3).toFixed(2);
					$('.visit-ppd-' + visitNumber).text(ppd);

					$('.first-dart-visit-total-' + visitNumber).text(firstScoreChanged * firstMultiplierChanged);
					$('.second-dart-visit-total-' + visitNumber).text(secondScoreChanged * secondMultiplierChanged);
					$('.third-dart-visit-total-' + visitNumber).text(thirdScoreChanged * thirdMultiplierChanged);

					firstDartField.data('score', firstScoreChanged);
					secondDartField.data('score', secondScoreChanged);
					thirdDartField.data('score', thirdScoreChanged);

					firstDartMultiplierField.data('multiplier', firstMultiplierChanged);
					secondDartMultiplierField.data('multiplier', secondMultiplierChanged);
					thirdDartMultiplierField.data('multiplier', thirdMultiplierChanged);

					// Save the data
					var data = JSON.stringify({
						'scoreId': visitNumber,
						'firstDart': firstScoreChanged,
						'secondDart': secondScoreChanged,
						'thirdDart': thirdScoreChanged,
						'firstDartMultiplier': firstMultiplierChanged,
						'secondDartMultiplier': secondMultiplierChanged,
						'thirdDartMultiplier': thirdMultiplierChanged,
					});

					$(this).children('span').removeClass('glyphicon-floppy-disk').addClass('glyphicon-edit');
					$(this).data('issave', 0);

					/// Depending on the data-finished attribute of submit button, use different route and redirect
					var route = window.location.pathname;
					var routeRedirect = window.location.pathname;

					executePost(route, data, 'application/json',
						function (response) {
							if (response.statusCode == 200) {
								firstDartField.text(firstScoreChanged);
								secondDartField.text(secondScoreChanged);
								thirdDartField.text(thirdScoreChanged);
								firstDartMultiplierField.text(firstMultiplierChanged);
								secondDartMultiplierField.text(secondMultiplierChanged);
								thirdDartMultiplierField.text(thirdMultiplierChanged);
							} else {
								alert('Error changing score.');
							}
						},
						function (error) {
							// TODO Error handling
							console.log("Unable to proceed: " + error.responseText);
						}
					);
				} else {
					firstDartField.text('').append('<input type="text" value="' + firstDartValue + '" class="form-control" style="max-width: 50px;" />');
					secondDartField.text('').append('<input type="text" value="' + secondDartValue + '" class="form-control" style="max-width: 50px;" />');
					thirdDartField.text('').append('<input type="text" value="' + thirdDartValue + '" class="form-control" style="max-width: 50px;" />');

					firstDartMultiplierField.text('').append('<input type="text" value="' + firstDartMultiplierValue + '" class="form-control" style="max-width: 50px;" />');
					secondDartMultiplierField.text('').append('<input type="text" value="' + secondDartMultiplierValue + '" class="form-control" style="max-width: 50px;" />');
					thirdDartMultiplierField.text('').append('<input type="text" value="' + thirdDartMultiplierValue + '" class="form-control" style="max-width: 50px;" />');

					$(this).children('span').removeClass('glyphicon-edit').addClass('glyphicon-floppy-disk');
					$(this).data('issave', 1);
				}
			});

			$('#continue-match').click(function () {
				location.href = '/match/' + $(this).data('match');
			});
		});
	script.
		var size = 20;
		var spread = 20;
		var intensity = 50;
		var scoresMap = !{JSON.stringify(scoresMap)};
		window.onload = function(){
			var canvas = $('#dartboard-heatmap')[0];
			drawHeatmap(canvas, scoresMap, 0, size, spread, intensity);
		}
		$(function () {
			$("#heatmap_value_selector").change(function () {
				var canvas = $('#dartboard-heatmap')[0];
				var display = this.value;
				drawHeatmap(canvas, scoresMap, display, size, spread, intensity);
			});
		});

block content
	h2 Results

	p.
		ID: #{match.id} <br>
		Started: #{match.created_at} <br>
		Finished: #{match.end_time === undefined ? '' : match.end_time} <br>
		Duration: #{((Date.parse(match.end_time)/1000 - Date.parse(match.created_at)/1000) / (60)).toFixed()} minutes <br>
		Stakes: #{match.stake === undefined ? "None" : match.stake}

	if match.winner_id !== null
		table(id='match_result_table' class='table table-striped table-bordered')
			thead
				tr
					th Player
					th Darts Thrown
					th First 9 PPD
					th PPD
					th Scores
					th Winner
			tbody
				each player in players
					- var statistics = player.statistics;
					tr
						td
							p= player.name
						td
							p= statistics.darts_thrown
						td
							p= statistics.first_nine_ppd.toFixed(2)
						td
							p= statistics.ppd.toFixed(2)
						td
							p= statistics['60s_plus'] === 0 ? "" : "60+: " + statistics['60s_plus']
							p= statistics['100s_plus'] === 0 ? "" : "100+: " + statistics['100s_plus']
							p= statistics['140s_plus'] === 0 ? "" : "140+: " + statistics['140s_plus']
							p= statistics['180s'] === 0 ? "" : "180:  " + statistics['180s']

						if match.winner_id !== undefined && player.id === match.winner_id
							td
								span(class='glyphicon glyphicon-ok' aria-hidden='true')
						else
							td
	div(style='margin-bottom: 20px;')
		if match.winner_id === null
			button(type='button' class='btn btn-primary' id='continue-match' data-match=match.id) Continue match

	h3 Match Results
	p.
		Starting score was #{match.starting_score}, and a total of #{scoresMap.totalThrows} darts were thrown by #{Object.keys(players).length} players

	button(class='btn btn-primary btn-block' data-toggle="collapse" data-target="#visits_div") Show Visits
	div(id="visits_div" class="collapse")
		table(class='table table-striped table-bordered' id='match_visits_table')
			thead
				tr
					th Player
					th(colspan='3') First Dart
					th(colspan='3') Second Dart
					th(colspan='3') Third Dart
					th Total
					th PPD
					th(class="txt-center") Options
			tbody
				each throws in scores
					tr(id="visit-" + throws.id)
						td= players[throws.player_id].name
						td(id='first-dart-visit-' + throws.id data-score=throws.first_dart)= throws.first_dart
						td(id='first-dart-multiplier-visit-' + throws.id data-multiplier=throws.first_dart_multiplier)
							select(class='form-control' name='first-dart-multiplier-vist' + throws.id disabled)
								option(selected=throws.first_dart_multiplier === 1) Single
								option(selected=throws.first_dart_multiplier === 2) Double
								option(selected=throws.first_dart_multiplier === 3) Treble
						td
							label(class='label label-success' class='first-dart-visit-total-' + throws.id)= throws.first_dart * throws.first_dart_multiplier
						td(id='second-dart-visit-' + throws.id data-score=throws.second_dart)= throws.second_dart
						td(id='second-dart-multiplier-visit-' + throws.id data-multiplier=throws.second_dart_multiplier)
							select(class='form-control' name='second-dart-multiplier-vist' + throws.id disabled)
								option(selected=throws.second_dart_multiplier === 1) Single
								option(selected=throws.second_dart_multiplier === 2) Double
								option(selected=throws.second_dart_multiplier === 3) Treble
						td
							label(class='label label-success' class='second-dart-visit-total-' + throws.id)= throws.second_dart * throws.second_dart_multiplier
						td(id='third-dart-visit-' + throws.id data-score=throws.third_dart)= throws.third_dart
						td(id='third-dart-multiplier-visit-' + throws.id data-multiplier=throws.third_dart_multiplier)
							select(class='form-control' name='second-dart-multiplier-vist' + throws.id disabled)
								option(selected=throws.third_dart_multiplier === 1) Single
								option(selected=throws.third_dart_multiplier === 2) Double
								option(selected=throws.third_dart_multiplier === 3) Treble
						td
							label(class='label label-success' class='third-dart-visit-total-' + throws.id)= throws.third_dart * throws.third_dart_multiplier
						td(class='total-visit-score-' + throws.id)= (throws.first_dart * throws.first_dart_multiplier) + (throws.second_dart * throws.second_dart_multiplier) + (throws.third_dart * throws.third_dart_multiplier)
						td(class='visit-ppd-' + throws.id)= (((throws.first_dart * throws.first_dart_multiplier) + (throws.second_dart * throws.second_dart_multiplier) + (throws.third_dart * throws.third_dart_multiplier)) / 3).toFixed(2)
						td(class="txt-center")
							button(type="button" class="btn btn-default edit-visit" data-visit=throws.id data-issave='0')
								span(class="glyphicon glyphicon-edit" aria-hidden="true")

	h3 Match Heatmap
	select(id='heatmap_value_selector' name='dartValues')
		option(value=0 default=true) All
		option(value=1) Singles
		option(value=2) Doubles
		option(value=3) Trebles
	div(style='text-align: center;')
		canvas(id='dartboard-heatmap')

	h3 Hits
	div(class='table-responsive')
		table(id='hits_table' class='table table-striped table-bordered')
			thead
				tr
					th Dart
					th Count
					th Hit %
			tbody
				each score, key  in scoresMap
					each value, multiplier in scoresMap[key]
						tr
							td(class='col-sm-2 dart-score-container' data-order=key + multiplier)
								if multiplier == 3
									label(style='background-color: #d9534f')= 'T-' + key
								else if multiplier == 2
									if key == 25
										label(style='background-color: orange') Bull
									else
										label(style='background-color: orange')= 'D-' + key
								else
									if key == 0
										label Miss
									else if key == 25
										label Bull
									else
										label= key
							td= value
							td= (value * 100 / scoresMap.totalThrows).toFixed(2) + '%'

